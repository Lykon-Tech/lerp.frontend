<p-toast></p-toast>
<p-dialog [(visible)]="dialogo" [style]="{ width: '450px' }" header="Detalhes do movimento" [modal]="true">
</p-dialog>

<p-toolbar class="text-sm p-2">
  <ng-template #start>
    <div class="flex gap-2 flex-wrap items-center">
        <p-button
            label="Novo"
            icon="pi pi-plus"
            severity="secondary"
            (click)="openNew()"
        ></p-button>

        <p-button severity="secondary" label="Editar" icon="pi pi-pencil" outlined (onClick)="editarMovimentos()" [disabled]="!movimentosSelecionados || !movimentosSelecionados.length" />

        <p-button
            label="Importar OFX"
            icon="pi pi-file-import"
            severity="secondary"
            (click)="fileInput.click()"
        ></p-button>
        
        <input
            #fileInput
            type="file"
            accept=".ofx,.qfx"
            (change)="importOfx($event)"
            style="display: none"
        />
    </div>
  </ng-template>

  <ng-template #center>
    <div class="flex flex-wrap gap-4 items-center">
      <div class="flex flex-col sm:flex-row sm:items-center gap-2">
        <label for="startDate" class="font-bold">Data de Início:</label>
        <p-date-picker
          [(ngModel)]="filtro.dataInicio"
          inputId="startDate"
          [showIcon]="true"
          dateFormat="dd/mm/yy"
          placeholder="Selecione a data de início"
          [maxDate]="filtro.dataFim || null"
          appendTo="body"
          styleClass="w-full sm:w-auto"
        ></p-date-picker>
      </div>

      <div class="flex flex-col sm:flex-row sm:items-center gap-2">
        <label for="endDate" class="font-bold">Data de Fim:</label>
        <p-date-picker
          [(ngModel)]="filtro.dataFim"
          inputId="endDate"
          [showIcon]="true"
          dateFormat="dd/mm/yy"
          placeholder="Selecione a data de fim"
          [minDate]="filtro.dataInicio || null"
          appendTo="body"
          styleClass="w-full sm:w-auto"
        ></p-date-picker>
      </div>

      <p-button
        label="Aplicar Filtro"
        icon="pi pi-filter"
        (click)="loadDemoData()"
        [disabled]="!filtro.dataInicio || !filtro.dataFim"
        styleClass="p-button-primary ml-auto sm:ml-0"
      ></p-button>
    </div>
  </ng-template>
</p-toolbar>

<div class="card">
    <div class="font-semibold text-xl mb-4">Movimentos Financeiros</div>

    <p-table
        #dt
        [value]="lista()"
        dataKey="id"
        class="text-xs"  
        [rows]="10"
        (input)="onGlobalFilter(dt, $event)"
        (onFilter)="filtrarSaldo(dt)"
        [loading]="loading"
        [paginator]="true"
        [showGridlines]="true"
        [(selection)]="movimentosSelecionados"
        [rowHover]="true"
        responsiveLayout="scroll"
        currentPageReportTemplate="Mostrando de {first} até {last} de {totalRecords} movimentos"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 20, 30]"
        [globalFilterFields]="['conta.numeroConta','subconta.nome', 'dataLancamento', 'tipoDocumento.nome', 'valor', 'numeroDocumento', 'historico']"
    >
        <ng-template #caption>
            <div class="flex justify-between items-center">
                <button pButton label="Limpar" icon="pi pi-filter-slash" class="p-button-outlined" (click)="dt.clear()"></button>
                <p-iconfield iconPosition="left" class="ml-auto">
                    <p-inputicon>
                        <i class="pi pi-search"></i>
                    </p-inputicon>
                    <input
                        pInputText
                        type="text"
                        (input)="onGlobalFilter(dt, $event)"
                        placeholder="Buscar..." />
                </p-iconfield>
            </div>
        </ng-template>

        <ng-template #header>
            <tr class="text-xs">
                <th style="width: 3rem">
                    <p-tableHeaderCheckbox />
                </th>
                <th style="min-width: 8rem">
                    Data
                    <p-columnFilter  dataType="date" dateFormat="dd/mm/yy" type="date" field="dataLancamento" display="menu" placeholder="dd/mm/aaaa" />
                </th>
                <th style="min-width: 8rem">
                    Conta
                    <p-columnFilter type="text" field="conta.numeroConta" display="menu" placeholder="Buscar por conta" matchMode="contains"/>
                </th>
                <th style="min-width: 10rem">
                    Subconta
                    <p-columnFilter type="text" field="subconta.nome" display="menu" placeholder="Buscar por subconta" matchMode="contains"/>
                </th>
                <th style="min-width: 12rem">
                    Tipo Documento
                    <p-columnFilter type="text" field="tipoDocumento.nome" display="menu" placeholder="Buscar por tipo" matchMode="contains"/>
                </th>
                <th style="min-width: 12rem">
                    Nº Documento
                    <p-columnFilter type="text" field="numeroDocumento" display="menu" matchMode="contains"/>
                </th>
                <th style="min-width: 10rem">
                    Histórico
                    <p-columnFilter type="text" field="historico" display="menu" matchMode="contains"/>
                </th>
                <th style="min-width: 8rem" field="valor">
                    Valor
                </th>
                <th style="min-width: 12rem">Ações</th>
            </tr>
        </ng-template>

        <ng-template #body let-mov>
            <tr class="text-xs">
                <td class="p-1" style="width: 3rem">
                    <p-tableCheckbox [value]="mov" />
                </td>
                <td >{{ mov?.dataLancamento | date:'dd/MM/yyyy' }}</td>
                <td class="p-1">{{ mov?.conta.banco.numeroBanco + ' - ' + mov?.conta.banco.nome + ' / ' + mov?.conta.numeroConta }}</td>
                <td class="p-1">
                    <p-tag [value]="mov.agrupamentos.length > 0 ? 'AGRUPADO' : mov.subconta.nome" severity="info" styleClass="rounded-full" />
                </td>
                <td class="p-1">
                    <p-tag [value]="mov.tipoDocumento?.nome" severity="primary" styleClass="rounded-full" />
                </td>
                <td class="p-1">{{ mov?.numeroDocumento }}</td>
                <td class="p-1">{{ mov?.historico }}</td>
                <td class="p-1">
                    <p-tag [value]="formatarValor(mov?.valor)" [severity]="getSeverity(mov?.subconta.tipo == 'ENTRADA')" />
                <td class="p-1">
                    <p-button icon="pi pi-chevron-down" class="mr-2" severity="warn" [rounded]="true" [outlined]="true" (click)="agrupar(mov)" />
                    <p-button icon="pi pi-pencil" class="mr-2" [rounded]="true" [outlined]="true" (click)="edit(mov)" />
                    <p-button icon="pi pi-trash" severity="danger" [rounded]="true" [outlined]="true" (click)="delete(mov)" />
                </td>
            </tr>
        </ng-template>
        <ng-template #footer>
            <tr>
                <td colspan="7" class="text-right font-bold">Total do Saldo:</td>
                <td colspan="1">
                    <p-tag [value]="saldo" [severity]="getSeverity(this.totalSaldo(dt) >= 0)" styleClass="rounded-full" />
                </td>
                <td colspan="2"></td>
            </tr>
        </ng-template>

        <ng-template #emptymessage>
            <tr><td colspan="7">Nenhum movimento encontrado.</td></tr>
        </ng-template>

        <ng-template #loadingbody>
            <tr><td colspan="7">Carregando dados...</td></tr>
        </ng-template>
    </p-table>

    <p-dialog [(visible)]="dialogo" [style]="{ width: '450px' }" header="Detalhes do movimento" [modal]="true">
        <ng-template #content>
            <div class="flex flex-col gap-6">

                <div>
                    <label for="dataLancamento" class="block font-bold mb-3">Data Lançamento</label>
                    <p-datepicker
                        id="dataLancamento"
                        [(ngModel)]="objeto.dataLancamento"
                        dateFormat="dd/mm/yy"
                        inputId="dataLancamento"
                        placeholder="Selecione a data"
                        [showIcon]="true"
                        [disabled]="objeto.importadoOfx ?? false"
                        [showButtonBar]="true"
                        fluid
                    />
                    <small class="text-red-500" *ngIf="submitted && !objeto.dataLancamento">Data de lançamento é obrigatória.</small>
                </div>
            
                <div>
                    <label for="valor" class="block font-bold mb-3">Valor</label>
                    <input
                    name="valor"
                    type="number"
                    pInputText
                    [disabled]="objeto.importadoOfx ?? false"
                    id="valor"
                    [(ngModel)]="objeto.valor"
                    required
                    autofocus
                    fluid
                    />
                    <small class="text-red-500" *ngIf="submitted && objeto.valor == undefined">Valor é obrigatório.</small>
                </div>

                 <div>
                    <label for="contas" class="block font-bold mb-3">Conta</label>
                    <p-select
                    name="contas"
                    [(ngModel)]="objeto.conta"
                    inputId="conta"
                    [options]="contas_select"
                    [disabled]="objeto.importadoOfx ?? false"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Selecione uma conta"
                    fluid
                    required
                    ></p-select>
                    <small class="text-red-500" *ngIf="submitted && (objeto.conta == undefined ||  objeto.conta.agencia == undefined)">Conta é obrigatório.</small>
                </div>

                <div>
                    <label for="subcontas" class="block font-bold mb-3">Subconta</label>
                    <p-autocomplete
                        name="subcontas"
                        [(ngModel)]="objeto.subconta"
                        dropdown
                        [forceSelection]="false"
                        [suggestions]="subcontas_select"
                        (completeMethod)="filterSubconta($event)"
                        optionLabel="nome"
                        placeholder="Selecione uma subconta"
                        fluid
                        appendTo="body"
                    ></p-autocomplete>
                    <small class="text-red-500" *ngIf="submitted && (objeto.subconta == undefined || objeto.subconta.nome == undefined)">Subconta é obrigatório.</small>
                </div>

                <div>
                    <label for="tipo_documentos" class="block font-bold mb-3">Tipo de Documento</label>
                    <p-select
                    name="tipo_documentos"
                    [(ngModel)]="objeto.tipoDocumento"
                    inputId="tipo_documento"
                    [options]="tipoDocumentos_select"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Selecione um tipo de documento"
                    fluid
                    ></p-select>
                </div>

                <div>
                    <label for="historico" class="block font-bold mb-3">Histórico</label>
                    <input
                    type="text"
                    pInputText
                    id="historico"
                    [(ngModel)]="objeto.historico"
                    maxlength="255"
                    placeholder="Descreva o histórico"
                    fluid
                    />
                    <small class="text-red-500" *ngIf="submitted && objeto.historico == undefined">Histórico é obrigatório.</small>
                </div>

                
                <div>
                    <label for="numeroDocumento" class="block font-bold mb-3">Número do Documento</label>
                    <input
                    type="text"
                    pInputText
                    id="numeroDocumento"
                    [(ngModel)]="objeto.numeroDocumento"
                    maxlength="50"
                    placeholder="Número do documento"
                    [disabled]="objeto.importadoOfx ?? false"
                    fluid
                    />
                </div>

                <div>
                    <label for="numero_movimento" class="block font-bold mb-3">Número do movimento</label>
                    <input
                    type="text"
                    pInputText
                    id="numero_movimento"
                    [(ngModel)]="objeto.numeroMovimento"
                    maxlength="50"
                    placeholder="Número do movimento"
                    fluid
                    />
                </div>

                <div>
                    <label for="observacao" class="block font-bold mb-3">Observação</label>
                    <textarea
                    pInputTextarea
                    id="observacao"
                    [(ngModel)]="objeto.observacao"
                    rows="3"
                    placeholder="Observações adicionais"
                    fluid
                    ></textarea>
                </div>

            </div>
        </ng-template>

        <ng-template #footer>
            <p-button label="Cancelar" icon="pi pi-times" text (click)="hideDialog()" />
            <p-button label="Salvar" [loading]="loadingSalvar" icon="pi pi-check" (click)="save()" />
        </ng-template>
    </p-dialog>

    <p-dialog  [(visible)]="dialogoEditar" [style]="{ width: '450px' }" header="Detalhes do movimento" [modal]="true">
        <ng-template #content>
            <div class="flex flex-col gap-6">
            
                <div>
                    <label for="subcontas" class="block font-bold mb-3">Subconta</label>
                    <p-autocomplete
                    name="subcontas"
                    [(ngModel)]="movimentoEditar.subconta"
                    dropdown
                    [forceSelection]="false"
                    [suggestions]="subcontas_select"
                    (completeMethod)="filterSubconta($event)"
                    optionLabel="nome"
                    placeholder="Selecione uma subconta"
                    fluid
                    appendTo="body"
                    ></p-autocomplete>
                </div>

                <div>
                    <label for="tipo_documentos" class="block font-bold mb-3">Tipo de Documento</label>
                    <p-select
                    name="tipo_documentos"
                    [(ngModel)]="movimentoEditar.tipoDocumento"
                    inputId="tipo_documento"
                    [options]="tipoDocumentos_select"
                    optionLabel="label"
                    optionValue="value"
                    placeholder="Selecione um tipo de documento"
                    appendTo="body"
                    fluid
                    ></p-select>
                </div>

            </div>
        </ng-template>

        <ng-template #footer>
            <p-button label="Cancelar" icon="pi pi-times" text (click)="hideDialogEditar()" />
            <p-button label="Salvar" icon="pi pi-check"  [loading]="loadingEditar"  (click)="saveEditar()" />
        </ng-template>
    </p-dialog>

    <p-confirmdialog [style]="{ width: '450px' }" />

    <p-dialog [(visible)]="dialogoAgrupamento" [style]="{ width: '600px' }" header="Agrupar Subcontas" [modal]="true">
        <ng-template #content>
            <div class="flex flex-col gap-4">

            <div class="flex flex-col gap-1">
                <label class="font-bold">Histórico</label>
                <span>{{ movimentoEditar.historico }}</span>

                <label class="font-bold mt-3">Valor Total do Movimento</label>
                <span>{{ movimentoEditar.valor | currency:'BRL' }}</span>
            </div>

            <div *ngIf="(movimentoEditar.agrupamentos ?? []).length > 0">
                <p-table [value]="(movimentoEditar.agrupamentos ?? [])" [responsiveLayout]="'scroll'" class="mt-3">
                <ng-template pTemplate="header">
                    <tr>
                    <th>Subconta</th>
                    <th>Valor</th>
                    <th>Ações</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-agrup>
                    <tr>
                    <td>{{ agrup.subconta.nome }}</td>
                    <td>{{ agrup.valor | currency:'BRL' }}</td>
                    <td>
                        <button pButton icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-sm"
                            (click)="removerAgrupamento(agrup)">
                        </button>
                    </td>
                    </tr>
                </ng-template>
                </p-table>
            </div>

            <div class="flex flex-col gap-2 mt-4">
                <label class="font-bold">Nova Subconta</label>
                <p-autocomplete
                [(ngModel)]="movimentoEditar.subconta"
                [suggestions]="subcontas_select"
                (completeMethod)="filterSubcontaAgrupar($event)"
                optionLabel="nome"
                dropdown
                fluid
                appendTo="body"
                placeholder="Selecione a subconta">
                </p-autocomplete>

                <label class="font-bold mt-2">Valor</label>
                <input type="number" pInputText [(ngModel)]="novoValor" placeholder="Digite o valor" />

                <small class="text-red-500" *ngIf="erroValor">A soma dos valores excede o total do movimento.</small>

                <button pButton label="Adicionar Subconta" class="mt-2" 
                        (click)="adicionarAgrupamento()" 
                        [disabled]="!subcontas || novoValor <= 0 || (valorDistribuido + novoValor) > (movimentoEditar.valor ?? 0)">
                </button>
            </div>

            <div class="mt-4 text-right">
                <strong>Valor distribuído: </strong>{{ valorDistribuido | currency:'BRL' }}<br />
                <strong>Restante: </strong>{{ (movimentoEditar.valor ?? 0) - valorDistribuido | currency:'BRL' }}
            </div>
            </div>
        </ng-template>

        <ng-template #footer>
            <p-button label="Cancelar" icon="pi pi-times" text (click)="dialogoAgrupamento = false" />
            <p-button label="Salvar" icon="pi pi-check" [loading]="loadingAgrupar" (click)="salvarAgrupamentos()" 
                    [disabled]="valorDistribuido !== movimentoEditar.valor" />
        </ng-template>
    </p-dialog>


</div>
